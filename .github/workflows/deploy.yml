name: Deploy Flutter Web to GitHub Pages

on:
  push:
    branches: 
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name:  Verify Flutter
        run: flutter doctor -v

      - name: Clean previous builds
        run: flutter clean

      - name: Get Dependencies
        run: flutter pub get

      - name: Build Web App
        run: flutter build web --release --base-href /my_web_portfolio/ --web-renderer canvaskit

      - name:  Verify build output
        run: |
          echo "Checking build output..."
          ls -la build/web/
          echo "Checking for critical files..."
          test -f build/web/index.html && echo "index.html exists" || echo "index.html missing"
          test -f build/web/flutter_bootstrap.js && echo "flutter_bootstrap.js exists" || echo "‚ö†Ô∏è  flutter_bootstrap.js missing (might be flutter. js)"
          test -f build/web/flutter.js && echo "flutter.js exists" || echo "‚ö†Ô∏è  flutter.js missing"
          test -f build/web/manifest.json && echo "manifest.json exists" || echo "manifest.json missing"

      - name: Add . nojekyll file
        run:  touch build/web/.nojekyll

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:  
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build/web
          publish_branch: gh-pages
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users. noreply.github.com'
          
      - name: Deployment Summary
        run: |
          echo "üéâ Deployment complete!"
          echo "üåê Your site will be available at: https://tanvivvce.github.io/my_web_portfolio/"
          echo "‚è±Ô∏è  Please wait 2-3 minutes for GitHub Pages to update"